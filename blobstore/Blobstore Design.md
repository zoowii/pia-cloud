Blobstore服务设计
====

调用blobstore的程序通过blobstore SDK来调用服务

上传服务中,SDK使用websocket协议传送二进制文件和其他信息,使用异步方式,回调只提供简单的成功或者失败或者超时的信息,并且只回调一次,不做更多处理.

blobstore对于每次传输的成功率考虑,限制每次传输的大小限制(比如最大4MB)

上传前计算MD5值,避免重复传输

上传文件如果大小超过每次传输大小限制,则分块传输,每次传输的内容称为chunk,每个chunk可以重试一次,所有chunk成功后返回成功信息,否则此次上传文件操作失败.

因为考虑到主要是提供给开发者在服务端使用的,并且已经听过了分片传输了,而且传输方式是基于TCP协议的,失败情况主要是访问失败,网络超时,流量不够等,所以暂时不考虑提供断点续传功能

无论是上传失败,或者超时,blobstore服务端都要把已经上传的内容删除

下载操作首先返回一个临时的或者持久的URL,临时URL在一定时间范围内有效(比如30分钟). 访问这类URL就可以直接获取到文件流(对应了MIME Type)

只要调用下载接口获得了一个访问URL,则在流量上就直接立刻计算完整的文件大小(因为返回的URL可能直接是外部服务的URL,另外,如果我们服务端下载好文件到web server后端,然后客户端下载了一点点就放弃了,这样做可以减少利用这点进行攻击的可能)

如果下载的目标文件的总大小超过剩余的流量,则直接返回失败信息,减少下载到中途然后提示流量不够的可能


上传下载操作要记录流量,所有操作要有日志记录


Blobstore的元信息,暂时直接存放到数据库中,将来可能转移到Datastore里面去

代码设计上采用middleware的方式,方便增加日志,流量统计,权限filter,计费,调用hooks等功能

对于blobstore上的文件,后续会增加文件夹管理,文件/文件夹/bucket重命名,遍历bucket/文件夹,删除,移动,获取列表,获取文件元信息,修改访问属性,修改mime-type等操作.(暂时不提供)

管理界面上后续会增加各种统计信息,bucket和文件管理等(暂时不提供)

可以创建多个Bucket,每个用户可以给每个bucket创建多个key-secret(有数量限制),可以给每个key-secret授予不同的权限

每个bucket中的文件都有一个public/private的访问属性,限制是否可以公开访问(所以下载操作返回的URL有两种),文件夹和bucket本身没有访问属性(这个和原设计不同),每次上传都必须明确指定访问属性和mime type

